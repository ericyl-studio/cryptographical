# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
# This workflow will build a package using Gradle and then publish it to Maven Central

name: Build and Release to Maven Central

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@417ae3ccd767c252f5661f1ace9f835f9654f2b5 # v3.1.0

      # è®¾ç½®ç‰ˆæœ¬å·ï¼ˆä»tagæå–ï¼‰
      - name: Set version from tag
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          # ç§»é™¤vå‰ç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          VERSION=${VERSION#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          sed -i "s/version = .*/version = '$VERSION'/" build.gradle
          echo "è®¾ç½®ç‰ˆæœ¬å·ä¸º: $VERSION"

      # æ„å»ºé¡¹ç›®å¹¶ç”Ÿæˆæ‰€æœ‰JARæ–‡ä»¶
      - name: Build with Gradle
        run: ./gradlew clean build

      # è¿è¡Œæµ‹è¯•
      - name: Run tests
        run: ./gradlew test

      # éªŒè¯ç”Ÿæˆçš„JARæ–‡ä»¶
      - name: Verify JAR artifacts
        run: |
          VERSION=${VERSION:-$(grep "version = " build.gradle | cut -d "'" -f 2)}
          echo "æ£€æŸ¥ç‰ˆæœ¬: $VERSION"
          echo "æ£€æŸ¥ç”Ÿæˆçš„JARæ–‡ä»¶..."

          JAR_DIR="build/libs"
          ls -la "$JAR_DIR/" || { echo "é”™è¯¯: JARç›®å½•ä¸å­˜åœ¨"; exit 1; }

          # éªŒè¯å¿…éœ€çš„JARæ–‡ä»¶å­˜åœ¨
          required_jars=(
            "cryptographical-$VERSION.jar"
            "cryptographical-$VERSION-sources.jar" 
            "cryptographical-$VERSION-javadoc.jar"
          )

          for jar in "${required_jars[@]}"; do
            if [ ! -f "$JAR_DIR/$jar" ]; then
              echo "é”™è¯¯: ç¼ºå°‘å¿…éœ€çš„JARæ–‡ä»¶ $jar"
              exit 1
            fi
            echo "âœ… æ‰¾åˆ°JARæ–‡ä»¶: $jar"
          done
          echo "âœ… æ‰€æœ‰å¿…éœ€çš„JARæ–‡ä»¶éƒ½å­˜åœ¨"

      # Maven Centralå‘å¸ƒ - Dry Run
      - name: Dry run publish to Maven Central
        run: ./gradlew jreleaserDeploy --dry-run
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          JRELEASER_GPG_PUBLIC_KEY: ${{ secrets.GPG_PUBLIC_KEY }}
          JRELEASER_GPG_SECRET_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          JRELEASER_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      # å®é™…å‘å¸ƒåˆ°Maven Central
      - name: Publish to Maven Central
        run: ./gradlew jreleaserDeploy
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          JRELEASER_GPG_PUBLIC_KEY: ${{ secrets.GPG_PUBLIC_KEY }}
          JRELEASER_GPG_SECRET_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          JRELEASER_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      # å‘å¸ƒæˆåŠŸåçš„æ€»ç»“
      - name: Publication Summary
        if: success()
        run: |
          VERSION=${VERSION:-$(grep "version = " build.gradle | cut -d "'" -f 2)}
          echo "ğŸ‰ å‘å¸ƒæˆåŠŸï¼"
          echo ""
          echo "ğŸ“¦ å‘å¸ƒä¿¡æ¯:"
          echo "  ç‰ˆæœ¬: $VERSION"
          echo "  GroupId: com.ericyl.utils"
          echo "  ArtifactId: cryptographical"
          echo ""
          echo "ğŸ“– ä½¿ç”¨æ–¹å¼:"
          echo "  Gradle: implementation 'com.ericyl.utils:cryptographical:$VERSION'"
          echo "  Maven:  <dependency>"
          echo "            <groupId>com.ericyl.utils</groupId>"
          echo "            <artifactId>cryptographical</artifactId>"
          echo "            <version>$VERSION</version>"
          echo "          </dependency>"
          echo ""
          echo "ğŸ” éªŒè¯ä½ç½®:"
          echo "  Central Portal: https://central.sonatype.com/publishing/deployments"
          echo "  Mavenæœç´¢: https://search.maven.org/search?q=g:com.ericyl.utils"
